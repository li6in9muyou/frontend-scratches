<!doctype html>
<html lang="zh" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <title>无穷滚动</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background-color: black;
        color: white;
      }

      main {
        height: 654px;
        border: solid 4px crimson;
        overflow-y: auto;
      }

      .content {
        height: 269px;
        margin: 6px;
        text-align: center;
        background-color: mediumvioletred;
        border: solid 2px white;
        font-size: 90px;
      }
    </style>

    <style>
      .ifs--item__loading {
        height: 269px;
        margin: 6px;
        text-align: center;
        background-color: dimgray;
        border: solid 2px white;
        font-size: 90px;
      }
    </style>
  </head>
  <body>
    <main></main>
  </body>
  <script src="js/jquery.js"></script>
  <script>
    function resolveAfter(milliseconds, result) {
      return new Promise((resolve) =>
        setTimeout(() => resolve(result), milliseconds),
      );
    }

    class WaitGroup {
      constructor(init = 0) {
        this.current = init;
        this.allDone = null;
        this.block = new Promise((resolve) => (this.allDone = resolve));
      }
      done() {
        this.current -= 1;
        if (this.current <= 0) {
          this.allDone();
        }
      }
      add(cnt = 1) {
        this.current += cnt;
      }
      wait() {
        return this.block;
      }
    }

    function* genNumbers(start, cnt, step = 1) {
      for (let i = 0; i < cnt; i++) {
        yield start + step * i;
      }
    }
  </script>
  <script>
    $(document).on("scroll wheel", (e) => {
      console.log("document event", e.type, e);
    });
  </script>
  <script type="module">
    const $list = $("main");

    const infiniteScrollEffect = new (function (viewportH, getItem, list) {
      this.LOADING_PLACEHOLDER_H = 269;
      this.renderedH = 0;
      this.vpH = viewportH;
      this.list = list;
      this.getItem = getItem;
      this.keyFront = 0;
      this.keyBack = 0;
      this.isLoading = false;

      function createLoadingPlaceholder(getContent) {
        const $b = $("<div class='ifs--item__loading'>loading</div>");
        getContent().then(($item) => {
          $item.insertAfter($b);
          $b.remove();
        });
        return $b;
      }

      this.__helperAddManyItems = (cnt, getNextKey, listModifier) => {
        const wg = new WaitGroup();
        for (let i = 0; i < cnt; i++) {
          wg.add();
          const key = getNextKey();
          const $item = createLoadingPlaceholder(() =>
            this.getItem(key).then(($item) => {
              wg.done();
              $item.attr("data-ifs-key", key);
              return $item;
            }),
          );
          listModifier($item);
        }
        return wg.wait();
      };

      this.addFrontManyItems = (cnt = 3) => {
        return this.__helperAddManyItems(
          cnt,
          () => {
            this.keyFront -= 1;
            return this.keyFront;
          },
          this.list.prepend.bind(this.list),
        );
      };

      this.addBackManyItems = (cnt = 3) => {
        return this.__helperAddManyItems(
          cnt,
          () => {
            const key = this.keyBack;
            this.keyBack += 1;
            return key;
          },
          this.list.append.bind(this.list),
        );
      };

      this.isLoading = true;
      this.addBackManyItems(6).then(() => (this.isLoading = false));

      document.addEventListener(
        "wheel",
        (e) => {
          console.log("wheel event isLoading", this.isLoading);
          if (this.isLoading) {
            return;
          }
          const scrollUp = e.deltaY < 0;
          const scrollToBottom =
            Math.abs(
              this.list[0].scrollHeight -
                this.list[0].clientHeight -
                this.list[0].scrollTop,
            ) < 3;
          const scrollToTop = this.list.scrollTop() === 0;
          if (scrollUp && scrollToTop) {
            this.isLoading = true;
            this.addFrontManyItems(3).then(() => (this.isLoading = false));
            this.list.scrollTop(3 * this.LOADING_PLACEHOLDER_H + e.deltaY);
          } else if (!scrollUp && scrollToBottom) {
            this.isLoading = true;
            this.addBackManyItems(3).then(() => (this.isLoading = false));
            this.list.scrollTop(this.list.scrollTop() + e.deltaY);
          }
        },
        { passive: true },
      );
    })(
      $list.innerHeight(),
      (key) => {
        const $c = $(`<div class="content">${key}</div>`);
        $c.css("height", Math.round(100 + 200 * Math.random()));
        return resolveAfter(1000 + 1000 * Math.random(), $c);
      },
      $list,
    );
  </script>
</html>
