<!doctype html>
<html lang="zh" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <title>无穷滚动</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background-color: black;
        color: white;
      }

      .content {
        height: 269px;
        margin: 6px;
        text-align: center;
        background-color: mediumvioletred;
        border: solid 2px white;
        font-size: 90px;
      }
    </style>

    <style>
      .ifs--item__loading {
        height: 269px;
        margin: 6px;
        text-align: center;
        background-color: dimgray;
        border: solid 2px white;
        font-size: 90px;
      }
    </style>
  </head>
  <body>
    <main></main>
  </body>
  <script src="js/jquery.js"></script>
  <script>
    function resolveAfter(milliseconds, result) {
      return new Promise((resolve) =>
        setTimeout(() => resolve(result), milliseconds),
      );
    }

    class WaitGroup {
      constructor(init = 0) {
        this.current = init;
        this.allDone = null;
        this.block = new Promise((resolve) => (this.allDone = resolve));
      }
      done() {
        this.current -= 1;
        if (this.current <= 0) {
          this.allDone();
        }
      }
      add(cnt = 1) {
        this.current += cnt;
      }
      wait() {
        return this.block;
      }
    }

    function* genNumbers(start, cnt, step = 1) {
      for (let i = 0; i < cnt; i++) {
        yield start + step * i;
      }
    }
  </script>
  <script>
    $(document).on("scroll wheel", (e) => {
      console.log("document event", e.type, e);
    });
  </script>
  <script type="module">
    const $list = $("main");

    const infiniteScrollEffect = new (function (viewportH, getItem, list) {
      this.renderedH = 0;
      this.vpH = viewportH;
      this.list = list;
      this.getItem = getItem;
      this.keyFront = 0;
      this.keyBack = 0;
      this.isLoading = false;
      this.addFirst = (cnt = 1) => {
        this.keyFront -= cnt;
        return this.keyFront;
      };
      this.removeFirst = (cnt = 1) => {
        this.keyFront += cnt;
        return this.keyFront;
      };
      this.addLast = (cnt = 1) => {
        this.keyBack += cnt;
        return this.keyBack;
      };
      this.removeLast = (cnt = 1) => {
        this.keyBack -= cnt;
        return this.keyBack;
      };

      function createLoadingPlaceholder(getContent) {
        const $b = $("<div class='ifs--item__loading'>loading</div>");
        getContent().then(($item) => {
          $item.insertAfter($b);
          $b.remove();
        });
        return $b;
      }

      this.addManyItems = (keys, keyModifier, effectiveKey, listModifier) => {
        const wg = new WaitGroup();
        for (const key of keys) {
          const thisKey = keyModifier();
          wg.add();
          const $item = createLoadingPlaceholder(() =>
            this.getItem(thisKey).then(($item) => {
              wg.done();
              $item.attr("data-ifs-key", thisKey);
              return $item;
            }),
          );
          listModifier($item);
        }
        return wg.wait();
      };

      this.isLoading = true;
      this.addManyItems(
        genNumbers(this.keyBack, 6),
        this.addLast,
        "keyBack",
        this.list.append.bind(this.list),
      ).then(() => (this.isLoading = false));

      document.addEventListener(
        "wheel",
        (e) => {
          if (this.isLoading) {
            return;
          }
          this.isLoading = true;

          const viewportUp = e.deltaY < 0;
          let updateKey, effectiveKey, updateList;
          if (viewportUp) {
            updateKey = this.addFirst.bind(this);
            effectiveKey = "keyFront";
            updateList = this.list.prepend.bind(this.list);
          } else {
            updateKey = this.addLast.bind(this);
            effectiveKey = "keyBack";
            updateList = this.list.append.bind(this.list);
          }

          this.addManyItems(
            genNumbers(this[effectiveKey], 3, Math.sign(e.deltaY)),
            updateKey,
            effectiveKey,
            updateList,
          ).then(() => (this.isLoading = false));
        },
        { passive: true },
      );
    })(
      $list.innerHeight(),
      (key) => {
        const $c = $(`<div class="content">${key}</div>`);
        $c.css("height", Math.round(100 + 200 * Math.random()));
        return resolveAfter(1000 + 1000 * Math.random(), $c);
      },
      $list,
    );
  </script>
</html>
