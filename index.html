<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Scratch</title>
  <link rel="stylesheet/less" type="text/css" href="less/styles.less"/>
  <script src="https://cdn.staticfile.net/less.js/4.2.0/less.js"></script>
</head>

<body>
  <header>
    <i class="btn"><</i>
    <h1>产品签约</h1>
  </header>
  <div class="pull-down--pocket" data-loading="false">
    <span class="pull-down--msg">松手加载更多数据</span>
    <span class="pull-down--msg pull-down--msg__loading">正在加载中</span>
  </div>
  <main class="product-list-wrap">
    <section class="product-list-title">
      <h2>产品名称</h2>
      <h2>产品费率</h2>
    </section>
    <section class="product-list">
      <div class="product">
        <div class="product-id">
          <i class="product-icon" data-icon="images/icon-1.png"></i>
          <span class="product-name">微信支付</span>
        </div>
        <div class="product-rates">0.32%</div>
      </div>
      <div class="product">
        <div class="product-id">
          <i class="product-icon" data-icon="images/icon-1.png"></i>
          <span class="product-name">微信支付</span>
        </div>
        <div class="product-rates">0.32%</div>
      </div>
    </section>
  </main>
  <footer>
    线上产品费率不同，详情请咨询：400-0000-0000
  </footer>

  <script src="js/jquery.js"></script>
  <script>
    $("[data-icon]").each(function () {
      const i = $(this);
      i.css({
        "background-image": `url(${i.attr("data-icon")})`,
      });
    });
  </script>

  <script>
    const isPreferDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    if (isPreferDark) {
      $(":root").attr("data-theme", "dark");
    } else {
      $(":root").attr("data-theme", "light");
    }
  </script>

  <script src="js/draggable.js"></script>
  <script src="js/threading.js"></script>
  <script>
    let loading;
    const $productListWrap = $(".product-list-wrap");
    const $pullDown = $(".pull-down--pocket");
    const pullDownState = {
      shouldLoadAfterRelease: false,
      isLoading: false,
    };

    const d = new Draggable(
      $productListWrap[0],
      null,
      [async () => {
        if (!pullDownState.shouldLoadAfterRelease) {
          $productListWrap
            .css({
              top: 0,
              transition: "top .3s",
            })
            .one("transitionend", () => $productListWrap.css("transition", ""));
          return;
        }
        loading = sleep(2000, "some more list items");
        $productListWrap.css({ top: $pullDown.outerHeight(), transition: "top .3s" });
        $pullDown.attr("data-loading", "true");
        pullDownState.isLoading = true;
        const r = await loading;
        console.log(`data is ${r}, now the list should snap back`);
        pullDownState.isLoading = false;
        pullDownState.shouldLoadAfterRelease = false;
        $productListWrap
          .css("top", 0)
          .one("transitionend", () => {
            $pullDown.attr("data-loading", "false");
            $productListWrap.css("transition", "");
          });
      }],
      [
        Draggable.makeClampY(0, 200),
        Draggable.moveOnlyY,
        pos => {
          if (pos.y > 100) {
            pullDownState.shouldLoadAfterRelease = true;
          }
        },
      ],
    );
  </script>
</body>
</html>
