<!doctype html>
<html lang="zh" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <title>事件闭包</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background-color: black;
        color: white;
      }

      h2 {
        cursor: pointer;
        border: solid 5px limegreen;
      }

      main {
        height: 654px;
        overflow-y: auto;
      }

      .btn {
        height: 269px;
        margin: 6px 6px 0 6px;
        text-align: center;
        background-color: mediumvioletred;
        border: solid 2px white;
        font-size: 3rem;
      }

      .bg-red {
        background-color: red;
      }
    </style>
  </head>
  <body>
    <main>
      <button class="btn">foo: open heading <i></i></button>
      <button class="btn">bar: open heading <i></i></button>
    </main>
    <p>期望行为</p>
    <ol>
      <li>点击foo</li>
      <li>头条展开</li>
      <li>点击头条</li>
      <li>foo文字更新</li>
      <li>头条收起</li>
      <li>点击bar</li>
      <li>头条展开</li>
      <li>点击头条</li>
      <li>bar文字更新</li>
      <li>头条收起</li>
      <li>头条里面的数字为2</li>
    </ol>
    <p>实际行为</p>
    <ol>
      <li>点击foo</li>
      <li>头条展开</li>
      <li>点击头条</li>
      <li>foo文字更新</li>
      <li>头条收起</li>
      <li>点击bar</li>
      <li>头条展开</li>
      <li>点击头条</li>
      <li>bar文字更新</li>
      <li>头条收起</li>
      <li class="bg-red">头条里面的数字为3</li>
    </ol>
  </body>
  <script src="js/jquery.js"></script>
  <script type="module">
    const $main = $("main");
    let cntCallbackFired = 0;

    $(".btn").on("click", (e) => {
      const $b = $(e.target);
      const $nText = $b.children("i");
      const close = showHeading(null, (n) => {
        $nText.text(n);
        close();
      });
    });

    function showHeading(_, callback) {
      console.log("showHeading", _);

      let $h2 = $main.children("h2");
      if ($h2.length === 0) {
        const $t = $("<h2>");
        $t.prependTo($main);
        $t.text("heading: " + cntCallbackFired);
        $h2 = $t;
      } else {
        $h2.slideDown();
      }
      $h2.on("click", () => {
        callback(Math.random().toFixed(3));
        cntCallbackFired += 1;
        $h2.text("heading: " + cntCallbackFired);
      });
      return () => $h2.slideUp(1000);
    }
  </script>
</html>
